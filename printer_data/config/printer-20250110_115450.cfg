[include shell_command.cfg]
#Configuration file for the Anycubic Kobra 2 neo. (Trigorilla 4.0.1 Board)


#please read every comment before changing and using this config to ensure you dont break anything.


#DISCLAIMER
#This Printer config was written and optimized by and with the help of the Klipper forum group.
#THIS IS EXPERIMENTAL and nobody will give you any warranty in case your printer blows up.
#version 1.3.2
#fixed bed probing and set homing speed to a more sustainable value. Also added input shaper values generated by adxl measurement.
#please excuse any spelling or grammatical errors in my comments as english is not my native.
#comments by xenyonmedia and mysterious cable (reddit only)


#Included files
[include mainsail.cfg]
[include macro.cfg] 	#comment this if you dont have this macro file.
#[include adxl.cfg] #uncomment this if you want to connect an adxl sensor and have this config file


[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[exclude_object]

[output_pin power_ctrl]
pin: PB4
value: 1

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 1800
max_z_velocity: 40
max_z_accel: 100

[stepper_x]
step_pin: PA5
dir_pin: PA4
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA6
position_min: -4
position_endstop: -4
position_max: 304
homing_speed: 50

[stepper_y]
step_pin: PC4
dir_pin: PA7
enable_pin: !PC3
microsteps: 16
rotation_distance: 32
endstop_pin: !PC5
position_min: -6
position_endstop: -6
position_max: 300
homing_speed: 50

[stepper_z]
step_pin: PC7
dir_pin: !PC6
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
endstop_pin: PA8
#position_endstop: 0
position_min: -15
position_max: 350
homing_speed: 10

[stepper_z1]
step_pin: PB1
dir_pin: !PB0
enable_pin: !PC3
microsteps: 16
rotation_distance: 8

[extruder]
max_extrude_only_distance: 200
max_extrude_only_velocity: 60
max_extrude_only_accel: 3000
step_pin: PC14
dir_pin: !PC15
enable_pin: !PC3
microsteps: 16
rotation_distance: 7.71
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PC1
min_extrude_temp: 170
#control: pid
#pid_kp: 22.20
#pid_ki: 1.08
#pid_kd: 119.0
min_temp: 0
max_temp: 300

[heater_bed]
heater_pin: PA0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC0
#control: pid
#pid_kp: 97.1
#pid_ki: 1.41
#pid_kd: 1675.16
min_temp: 0
max_temp: 120

[filament_switch_sensor runout]
pause_on_runout: True
switch_pin: !PC13

[controller_fan controller_fan]
pin: PA14
heater: heater_bed

[heater_fan hotend_fan]
pin: PA13

[fan]
pin: PB9

[output_pin probe_reset_pin]
pin: PB7
value: 1

[safe_z_home]
home_xy_position: 0, 0
speed: 100
z_hop: 10
z_hop_speed: 15
move_to_previous: False

[probe]
pin: !PB6
speed: 5.0
lift_speed: 5.0
samples: 3
sample_retract_dist: 5
samples_result: average 
samples_tolerance: 0.5
samples_tolerance_retries: 3
x_offset: 0
y_offset: 0
#z_offset: 0.2
activate_gcode: probe_reset

[bed_mesh]
speed: 100
mesh_min: 2, 2
mesh_max: 298, 298
algorithm: bicubic
probe_count: 10, 10
mesh_pps: 4, 4
bicubic_tension: 0.2
fade_start: 1
fade_end: 10

[idle_timeout]
gcode:
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0 # disable the extruder motor
  M104 S0 # set hotend to 0C
# A list of G-Code commands to execute on an idle timeout. See
# docs/Command_Templates.md for G-Code format. The default is to run
# "TURN_OFF_HEATERS" and "M84".
timeout: 600
# Idle time (in seconds) to wait before running the above G-Code
# commands. The default is 600 seconds.

[gcode_macro probe_reset]
gcode:
  SET_PIN PIN=probe_reset_pin VALUE=0
  G4 P300
  SET_PIN PIN=probe_reset_pin VALUE=1
  G4 P100

[output_pin LED]
pin: PB8

[output_pin beeper]
pin: !PB5

[include moonraker_obico_macros.cfg]

[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 32.222
#*# pid_ki = 3.305
#*# pid_kd = 78.541
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.057
#*# pid_ki = 0.833
#*# pid_kd = 1473.821
#*#
#*# [stepper_z]
#*# position_endstop = -1.385
#*#
#*# [probe]
#*# z_offset = 0.010
#*#
#*# [bed_mesh OLD BAD]
#*# version = 1
#*# points =
#*# 	-1.650833, -1.463333, -1.361667, -1.253333, -1.131667, -1.028333, -0.939167, -0.607500, -0.868333, -0.738333
#*# 	-1.465833, -1.305833, -1.255833, -1.216667, -1.101667, -1.060000, -1.169167, -0.829167, -0.995000, -0.799167
#*# 	-1.341667, -1.246667, -1.115833, -1.040000, -0.921667, -0.884167, -0.830000, -0.540833, -0.820833, -0.557500
#*# 	-1.256667, -1.139167, -1.111667, -0.953333, -0.904167, -0.899167, -0.899167, -0.653333, -0.903333, -0.757500
#*# 	-1.302500, -1.155833, -1.062500, -0.960000, -0.886667, -0.850000, -0.753333, -0.525833, -0.818333, -0.735000
#*# 	-1.221667, -1.069167, -0.950000, -0.843333, -0.816667, -0.855000, -0.830000, -0.727500, -1.054167, -0.743333
#*# 	-1.231667, -0.986667, -0.907500, -0.792500, -0.740833, -0.709167, -0.716667, -0.622500, -0.827500, -0.690833
#*# 	-1.171667, -1.009167, -0.862500, -0.780833, -0.705000, -0.715000, -0.809167, -0.750833, -1.149167, -1.091667
#*# 	-1.417500, -1.060833, -0.917500, -0.764167, -0.725833, -0.707500, -0.691667, -0.545000, -0.993333, -0.854167
#*# 	-1.275833, -1.120000, -0.906667, -0.832500, -1.032500, -1.032500, -0.794167, -0.659167, -1.033333, -1.171667
#*# min_x = 2.0
#*# max_x = 297.92
#*# min_y = 2.0
#*# max_y = 297.92
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [bed_mesh new_pei]
#*# version = 1
#*# points =
#*# 	-4.328333, -4.217500, -4.123333, -4.073333, -3.958333, -3.896667, -3.839167, -3.504167, -3.659167, -3.421667
#*# 	-4.335833, -4.210833, -4.152500, -4.083333, -4.004167, -3.928333, -3.858333, -3.511667, -3.675833, -3.476667
#*# 	-4.163333, -4.055000, -4.018333, -3.952500, -3.874167, -3.837500, -3.791667, -3.480000, -3.689167, -3.496667
#*# 	-4.209167, -4.088333, -4.041667, -3.945000, -3.887500, -3.828333, -3.767500, -3.454167, -3.669167, -3.457500
#*# 	-4.164167, -4.037500, -3.982500, -3.946667, -3.865833, -3.840833, -3.825000, -3.537500, -3.775000, -3.600000
#*# 	-4.126667, -3.984167, -3.930833, -3.861667, -3.800000, -3.750000, -3.745833, -3.465000, -3.732500, -3.547500
#*# 	-4.045833, -3.904167, -3.869167, -3.756667, -3.735000, -3.720833, -3.725833, -3.464167, -3.761667, -3.653333
#*# 	-4.100833, -3.860000, -3.860000, -3.715000, -3.656667, -3.671667, -3.721667, -3.508333, -3.788333, -3.660000
#*# 	-4.057500, -3.930833, -3.811667, -3.781667, -3.760833, -3.660000, -3.724167, -3.510000, -3.794167, -3.715833
#*# 	-4.330000, -3.965000, -3.887500, -3.738333, -3.697500, -3.621667, -3.820000, -3.531667, -3.791667, -3.684167
#*# min_x = 2.0
#*# max_x = 297.92
#*# min_y = 2.0
#*# max_y = 297.92
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
